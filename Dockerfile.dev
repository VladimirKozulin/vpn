# Dockerfile для РАЗРАБОТКИ с hot-reload
# Использует Gradle bootRun для автоматической перезагрузки при изменениях

FROM gradle:8.5-jdk21

WORKDIR /app

# Устанавливаем Xray в отдельную директорию
RUN mkdir -p /opt/xray && \
    apt-get update && \
    apt-get install -y wget unzip curl && \
    cd /opt/xray && \
    echo "Downloading Xray..." && \
    wget --timeout=30 --tries=3 https://github.com/XTLS/Xray-core/releases/latest/download/Xray-linux-64.zip || \
    curl -L -o Xray-linux-64.zip https://github.com/XTLS/Xray-core/releases/latest/download/Xray-linux-64.zip && \
    echo "Extracting Xray..." && \
    unzip -q Xray-linux-64.zip && \
    chmod +x xray && \
    ls -la && \
    ./xray version && \
    rm -f Xray-linux-64.zip geoip.dat geosite.dat && \
    rm -rf /var/lib/apt/lists/*

# Исходники будут монтироваться через volume в docker-compose
# Gradle зависимости скачаются при первом запуске

# Открываем порты
EXPOSE 8080 443

# Запускаем в режиме разработки с автоперезагрузкой
CMD ["./gradlew", "bootRun", "--no-daemon"]
