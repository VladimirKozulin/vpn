# VPN Server - –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –õ–æ–≥–∏–∫–∞ –†–∞–±–æ—Ç—ã

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –°–µ—Ä–≤–∏—Å–æ–≤

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å  ‚îÇ
‚îÇ    (–ë—Ä–∞—É–∑–µ—Ä)    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ HTTPS (SSL)
         ‚îÇ :8080
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ      Spring Boot Application            ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ   Spring Security + OAuth2        ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ   Controllers (HomeController)    ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ   Services (VpnClientService,     ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ   XrayService, QrCodeService)     ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ                  ‚îÇ
       ‚îÇ gRPC             ‚îÇ JDBC
       ‚îÇ :10085           ‚îÇ :5432
       ‚ñº                  ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ    Xray     ‚îÇ    ‚îÇ  PostgreSQL  ‚îÇ
‚îÇ   Process   ‚îÇ    ‚îÇ   (vpn_db)   ‚îÇ
‚îÇ   :443      ‚îÇ    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚îÇ VLESS + Reality
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ VPN –ö–ª–∏–µ–Ω—Ç  ‚îÇ
‚îÇ  (v2rayN)   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         Keycloak (Auth Server)           ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ  Realm: vpn                        ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  Client: vpn-client                ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  Role: user                        ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ JDBC :5433
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  PostgreSQL  ‚îÇ
‚îÇ(keycloak_db) ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üîÑ Flow 1: –ü–µ—Ä–≤—ã–π –í—Ö–æ–¥ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–° Keycloak)

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí https://ip:8080/
   ‚Üì
2. Spring Security –≤–∏–¥–∏—Ç –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   ‚Üì
3. –†–µ–¥–∏—Ä–µ–∫—Ç ‚Üí http://localhost:8180/realms/vpn/protocol/openid-connect/auth
   ‚Üì
4. Keycloak –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ñ–æ—Ä–º—É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏/–ª–æ–≥–∏–Ω–∞
   ‚Üì
5. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è (email + –ø–∞—Ä–æ–ª—å)
   ‚Üì
6. Keycloak —Å–æ–∑–¥–∞—ë—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç authorization code
   ‚Üì
7. Spring Boot –æ–±–º–µ–Ω–∏–≤–∞–µ—Ç code –Ω–∞ JWT token (ID Token + Access Token)
   ‚Üì
8. Spring Security –∏–∑–≤–ª–µ–∫–∞–µ—Ç –∏–∑ JWT:
   - keycloak_user_id (UUID)
   - email
   - preferred_username
   ‚Üì
9. VpnClientService.getOrCreateClient():
   - –ò—â–µ—Ç vpn_clients –ø–æ keycloak_user_id
   - –ù–ï –ù–ê–ô–î–ï–ù ‚Üí –°–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å:
     * keycloak_user_id = UUID –∏–∑ JWT
     * email = email –∏–∑ JWT
     * uuid = –Ω–æ–≤—ã–π UUID –¥–ª—è Xray
     * is_active = true
     * created_at = now()
   ‚Üì
10. XrayGrpcClient.addUser(uuid) ‚Üí –î–æ–±–∞–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Xray —á–µ—Ä–µ–∑ gRPC
    ‚Üì
11. ConfigService.generateVlessLink(uuid) ‚Üí –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç VLESS —Å—Å—ã–ª–∫—É
    ‚Üì
12. QrCodeService.generateQrCode(vlessLink) ‚Üí –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç QR –∫–æ–¥
    ‚Üì
13. HomeController –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç index.html —Å QR –∫–æ–¥–æ–º
    ‚Üì
14. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —Å–≤–æ–π QR –∫–æ–¥
```

## üîÑ Flow 2: –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –í—Ö–æ–¥ (SSO)

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí https://ip:8080/
   ‚Üì
2. Spring Security –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–µ—Å—Å–∏—é
   ‚Üì
3. Keycloak –ø—Ä–æ–≤–µ—Ä—è–µ—Ç SSO —Å–µ—Å—Å–∏—é (cookie)
   ‚Üì
4. Keycloak –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç JWT token (–±–µ–∑ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –ª–æ–≥–∏–Ω–∞)
   ‚Üì
5. Spring Security –∏–∑–≤–ª–µ–∫–∞–µ—Ç keycloak_user_id –∏–∑ JWT
   ‚Üì
6. VpnClientService.getOrCreateClient():
   - –ò—â–µ—Ç vpn_clients –ø–æ keycloak_user_id
   - –ù–ê–ô–î–ï–ù ‚Üí –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∑–∞–ø–∏—Å—å
   ‚Üì
7. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –¢–û–¢ –ñ–ï QR –∫–æ–¥ (—Ç–æ—Ç –∂–µ UUID)
   ‚Üì
8. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —Å–≤–æ–π QR –∫–æ–¥
```

```

## üîê SSL/TLS

- **Spring Boot**: HTTPS –Ω–∞ –ø–æ—Ä—Ç—É 8080 —Å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–º `src/main/resources/ssl/keystore.p12`
- **Xray**: Reality –ø—Ä–æ—Ç–æ–∫–æ–ª (TLS fingerprint –º–∞—Å–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–¥ Chrome)
- **Keycloak**: HTTP –≤ dev —Ä–µ–∂–∏–º–µ (–≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –Ω—É–∂–µ–Ω HTTPS)

## ‚è±Ô∏è TTL –õ–æ–≥–∏–∫–∞ (5 –º–∏–Ω—É—Ç)

**Pending Clients (–≤ –ø–∞–º—è—Ç–∏):**
```java
PendingClient {
    uuid: String
    deviceInfo: String
    createdAt: LocalDateTime
    expiresAt: LocalDateTime  // createdAt + 5 –º–∏–Ω—É—Ç
}
```

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –°–æ–∑–¥–∞—ë—Ç—Å—è PendingClient –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR –∫–æ–¥–∞
2. –ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è –∑–∞–¥–∞—á–∞ —á–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç
3. –ß–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç:
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —á–µ—Ä–µ–∑ gRPC
   - –ï—Å–ª–∏ —Ç—Ä–∞—Ñ–∏–∫ > 0 ‚Üí —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î –∫–∞–∫ VpnClient
   - –ï—Å–ª–∏ —Ç—Ä–∞—Ñ–∏–∫ = 0 ‚Üí —É–¥–∞–ª—è–µ—Ç—Å—è –∏–∑ Xray

## üìä –ë–∞–∑–∞ –î–∞–Ω–Ω—ã—Ö

**vpn_clients:**
```sql
id                  BIGSERIAL PRIMARY KEY
keycloak_user_id    UUID UNIQUE NOT NULL
email               VARCHAR(255) UNIQUE NOT NULL
uuid                VARCHAR(36) UNIQUE NOT NULL  -- UUID –¥–ª—è Xray
device_info         VARCHAR(255)
is_active           BOOLEAN DEFAULT true
created_at          TIMESTAMP NOT NULL
first_connected_at  TIMESTAMP
last_connected_at   TIMESTAMP
```

**–ò–Ω–¥–µ–∫—Å—ã:**
- idx_keycloak_user_id
- idx_email
- idx_uuid

## üîó –°–≤—è–∑–∏ –ú–µ–∂–¥—É –°–µ—Ä–≤–∏—Å–∞–º–∏

**Spring Boot ‚Üî Xray:**
- –ü—Ä–æ—Ç–æ–∫–æ–ª: gRPC
- –ü–æ—Ä—Ç: 10085
- –û–ø–µ—Ä–∞—Ü–∏–∏: addUser(), removeUser(), getStats()

**Spring Boot ‚Üî PostgreSQL (vpn_db):**
- –ü—Ä–æ—Ç–æ–∫–æ–ª: JDBC
- –ü–æ—Ä—Ç: 5432
- ORM: Hibernate (JPA)

**Spring Boot ‚Üî Keycloak:**
- –ü—Ä–æ—Ç–æ–∫–æ–ª: OAuth2 / OpenID Connect
- –ü–æ—Ä—Ç—ã: 8180 (–≤–Ω–µ—à–Ω–∏–π), 8080 (–≤–Ω—É—Ç—Ä–∏ Docker)
- Endpoints:
  - authorization: http://localhost:8180/realms/vpn/protocol/openid-connect/auth
  - token: http://keycloak:8080/realms/vpn/protocol/openid-connect/token
  - jwks: http://keycloak:8080/realms/vpn/protocol/openid-connect/certs

**Keycloak ‚Üî PostgreSQL (keycloak_db):**
- –ü—Ä–æ—Ç–æ–∫–æ–ª: JDBC
- –ü–æ—Ä—Ç: 5433
- –ë–∞–∑–∞: keycloak_db

**Xray ‚Üî VPN –ö–ª–∏–µ–Ω—Ç:**
- –ü—Ä–æ—Ç–æ–∫–æ–ª: VLESS + Reality (TLS)
- –ü–æ—Ä—Ç: 443
- –ú–∞—Å–∫–∏—Ä–æ–≤–∫–∞: www.microsoft.com

## üöÄ –ó–∞–ø—É—Å–∫

```bash
```

## üîë Keycloak –ù–∞—Å—Ç—Ä–æ–π–∫–∏

- **Realm**: vpn
- **Client ID**: vpn-client
- **Client Secret**: (–≤ .env)
- **Role**: user
- **Valid Redirect URIs**: https://localhost:8080/*


## üõ†Ô∏è –ü–æ–ª–µ–∑–Ω—ã–µ –ö–æ–º–∞–Ω–¥—ã

### Docker –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã

```bash
# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∑–∞–ø—É—â–µ–Ω–Ω—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
docker ps

# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã (–≤–∫–ª—é—á–∞—è –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ)
docker ps -a

# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
docker logs vpn-server
docker logs keycloak
docker logs vpn-postgres
docker logs keycloak-postgres

# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
docker logs -f vpn-server

# –ó–∞–π—Ç–∏ –≤–Ω—É—Ç—Ä—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
docker exec -it vpn-server bash
docker exec -it keycloak bash
docker exec -it vpn-postgres bash

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
docker-compose restart vpn-server
docker-compose restart keycloak

# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
docker-compose down

# –£–¥–∞–ª–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∏ volumes
docker-compose down -v
```

### –ë–∞–∑–∞ –î–∞–Ω–Ω—ã—Ö VPN (PostgreSQL)

```bash
# –ó–∞–π—Ç–∏ –≤ PostgreSQL –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
docker exec -it vpn-postgres psql -U postgres -d vpn_db

# –ò–ª–∏ —á–µ—Ä–µ–∑ docker-compose
docker-compose exec postgres psql -U postgres -d vpn_db
```

**SQL –∫–æ–º–∞–Ω–¥—ã –≤–Ω—É—Ç—Ä–∏ PostgreSQL:**

```sql
-- –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã
\dt

-- –û–ø–∏—Å–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã vpn_clients
\d vpn_clients

-- –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤
SELECT * FROM vpn_clients;

-- –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤
SELECT id, email, uuid, is_active, created_at FROM vpn_clients WHERE is_active = true;

-- –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∫–ª–∏–µ–Ω—Ç–∞ –ø–æ email
SELECT * FROM vpn_clients WHERE email = 'user@example.com';

-- –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∫–ª–∏–µ–Ω—Ç–∞ –ø–æ Keycloak ID
SELECT * FROM vpn_clients WHERE keycloak_user_id = 'uuid-here';

-- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–ª–∏–µ–Ω—Ç–æ–≤
SELECT COUNT(*) FROM vpn_clients;

-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ 10 –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö
SELECT email, created_at FROM vpn_clients ORDER BY created_at DESC LIMIT 10;

-- –í—ã–π—Ç–∏ –∏–∑ psql
\q
```

### –ë–∞–∑–∞ –î–∞–Ω–Ω—ã—Ö Keycloak (PostgreSQL)

```bash
# –ó–∞–π—Ç–∏ –≤ Keycloak PostgreSQL
docker exec -it keycloak-postgres psql -U keycloak -d keycloak_db

# –ò–ª–∏ —á–µ—Ä–µ–∑ docker-compose
docker-compose exec keycloak-postgres psql -U keycloak -d keycloak_db
```

**SQL –∫–æ–º–∞–Ω–¥—ã –¥–ª—è Keycloak:**

```sql
-- –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã
\dt

-- –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
SELECT id, username, email, created_timestamp FROM user_entity;

-- –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π realm 'vpn'
SELECT u.id, u.username, u.email, u.created_timestamp 
FROM user_entity u 
JOIN realm r ON u.realm_id = r.id 
WHERE r.name = 'vpn';

-- –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∫–ª–∏–µ–Ω—Ç–æ–≤ (applications)
SELECT id, client_id, name, enabled FROM client WHERE realm_id = (SELECT id FROM realm WHERE name = 'vpn');

-- –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–æ–ª–∏ realm
SELECT id, name, description FROM keycloak_role WHERE realm_id = (SELECT id FROM realm WHERE name = 'vpn');

-- –í—ã–π—Ç–∏
\q
```

### Xray

```bash
# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é Xray
cat xray-config.json

# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏ Xray (—á–µ—Ä–µ–∑ Spring Boot)
docker logs vpn-server | grep Xray

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç–∞–µ—Ç –ª–∏ Xray –Ω–∞ –ø–æ—Ä—Ç—É 443
netstat -an | findstr :443

# –ò–ª–∏ —á–µ—Ä–µ–∑ PowerShell
Test-NetConnection -ComputerName localhost -Port 443
```

### Keycloak

```bash
# –ó–∞–π—Ç–∏ –≤ Keycloak CLI
docker exec -it keycloak /opt/keycloak/bin/kcadm.sh

# –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å realm –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
docker exec -it keycloak /opt/keycloak/bin/kc.sh export --dir /tmp --realm vpn

# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–∞–π–ª
docker exec -it keycloak cat /tmp/vpn-realm.json
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –°–µ—Ä–≤–∏—Å–æ–≤

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å Spring Boot
curl -k https://localhost:8080/

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å Keycloak
curl http://localhost:8180/

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Keycloak realm
curl http://localhost:8180/realms/vpn/.well-known/openid-configuration

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å PostgreSQL VPN
docker exec vpn-postgres pg_isready -U postgres

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å PostgreSQL Keycloak
docker exec keycloak-postgres pg_isready -U keycloak
```

### –û—á–∏—Å—Ç–∫–∞ –∏ –°–±—Ä–æ—Å

```bash
# –£–¥–∞–ª–∏—Ç—å –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∏ volumes (–û–°–¢–û–†–û–ñ–ù–û - —É–¥–∞–ª–∏—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ!)
docker-compose down -v

# –£–¥–∞–ª–∏—Ç—å —Ç–æ–ª—å–∫–æ Keycloak –¥–∞–Ω–Ω—ã–µ
docker volume rm vpn_keycloak-postgres-data

# –£–¥–∞–ª–∏—Ç—å —Ç–æ–ª—å–∫–æ VPN –¥–∞–Ω–Ω—ã–µ
docker volume rm vpn_postgres-data

# –ü–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å –≤—Å—ë —Å –Ω—É–ª—è
docker-compose down -v
docker-compose up -d

# –ü–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å —Ç–æ–ª—å–∫–æ Keycloak —Å –∞–≤—Ç–æ–∏–º–ø–æ—Ä—Ç–æ–º realm
docker-compose down keycloak keycloak-postgres
docker volume rm vpn_keycloak-postgres-data
docker-compose up keycloak-postgres keycloak -d
```

### –ë—ç–∫–∞–ø –∏ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ

```bash
# –ë—ç–∫–∞–ø VPN –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
docker exec vpn-postgres pg_dump -U postgres vpn_db > backup_vpn_$(date +%Y%m%d).sql

# –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ VPN –±–∞–∑—ã
cat backup_vpn_20260207.sql | docker exec -i vpn-postgres psql -U postgres -d vpn_db

# –ë—ç–∫–∞–ø Keycloak –±–∞–∑—ã
docker exec keycloak-postgres pg_dump -U keycloak keycloak_db > backup_keycloak_$(date +%Y%m%d).sql

# –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ Keycloak –±–∞–∑—ã
cat backup_keycloak_20260207.sql | docker exec -i keycloak-postgres psql -U keycloak -d keycloak_db
```

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

```bash
# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º–∏
docker stats

# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–∏—Å–∫–æ–≤–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞
docker system df

# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–µ—Ç–µ–≤—ã–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
docker network ls
docker network inspect vpn_vpn-network

# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å volumes
docker volume ls
docker volume inspect vpn_postgres-data
```


–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —Ç–µ–±–µ –Ω–∞–π—Ç–∏ –ª–æ–≥–∏–∫—É –∏—Å—Ç–µ—á–µ–Ω–∏—è 5 –º–∏–Ω—É—Ç–Ω–æ–≥–æ ttl –∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π vless —Å—Å—ã–ª–∫–∏. 

–°–µ–π—á–∞—Å —É –Ω–∞—Å –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç, –Ω–æ —Ç–æ–≥–¥–∞ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è —Å—Ä–∞–∑—É –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –ø—É—Å—Ç–æ, –Ω—É–∂–Ω–æ –∂–¥–∞—Ç—å 5 –º–∏–Ω—É—Ç –ø–µ—Ä–µ–¥ —Ç–µ–º –∫–∞–∫ –¥–∞–Ω–Ω—ã–µ –ø–æ—è–≤—è—Ç—Å—è –≤ –±–∞–∑–µ. –ê –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫ —Å–µ—Ä–≤–µ—Ä—É —É –Ω–∞—Å —Ç—É—Ç –∂–µ –ø–æ—è–≤–ª—è—é—Ç—Å—è –ª–æ–≥–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫ —Å–µ—Ä–≤–µ—Ä—É. 

–°–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –º—ã –º–æ–∂–µ–º –≤ —Ç–∞–∫–æ–º —Å–ª—É—á–∞–µ –æ—Ç–º–µ–Ω—è—Ç—å 5 –º–∏–Ω—É—Ç–Ω—É–µ –æ–∂–∏–¥–∞–Ω–∏–µ –∏ —Å—Ä–∞–∑—É –∂–µ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –µ–≥–æ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö. 

