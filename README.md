# VPN Server - –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –õ–æ–≥–∏–∫–∞ –†–∞–±–æ—Ç—ã

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –°–µ—Ä–≤–∏—Å–æ–≤

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å  ‚îÇ
‚îÇ    (–ë—Ä–∞—É–∑–µ—Ä)    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ HTTPS (SSL)
         ‚îÇ :8080
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ      Spring Boot Application            ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ   Spring Security + OAuth2        ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ   Controllers (HomeController)    ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ   Services (VpnClientService,     ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ   XrayService, QrCodeService)     ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ                  ‚îÇ
       ‚îÇ gRPC             ‚îÇ JDBC
       ‚îÇ :10085           ‚îÇ :5432
       ‚ñº                  ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ    Xray     ‚îÇ    ‚îÇ  PostgreSQL  ‚îÇ
‚îÇ   Process   ‚îÇ    ‚îÇ   (vpn_db)   ‚îÇ
‚îÇ   :443      ‚îÇ    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚îÇ VLESS + Reality
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ VPN –ö–ª–∏–µ–Ω—Ç  ‚îÇ
‚îÇ  (v2rayN)   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         Keycloak (Auth Server)           ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ  Realm: vpn                        ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  Client: vpn-client                ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  Role: user                        ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ JDBC :5433
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  PostgreSQL  ‚îÇ
‚îÇ(keycloak_db) ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üîÑ Flow 1: –ü–µ—Ä–≤—ã–π –í—Ö–æ–¥ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–° Keycloak)

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí https://ip:8080/
   ‚Üì
2. Spring Security –≤–∏–¥–∏—Ç –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   ‚Üì
3. –†–µ–¥–∏—Ä–µ–∫—Ç ‚Üí http://localhost:8180/realms/vpn/protocol/openid-connect/auth
   ‚Üì
4. Keycloak –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ñ–æ—Ä–º—É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏/–ª–æ–≥–∏–Ω–∞
   ‚Üì
5. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è (email + –ø–∞—Ä–æ–ª—å)
   ‚Üì
6. Keycloak —Å–æ–∑–¥–∞—ë—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç authorization code
   ‚Üì
7. Spring Boot –æ–±–º–µ–Ω–∏–≤–∞–µ—Ç code –Ω–∞ JWT token (ID Token + Access Token)
   ‚Üì
8. Spring Security –∏–∑–≤–ª–µ–∫–∞–µ—Ç –∏–∑ JWT:
   - keycloak_user_id (UUID)
   - email
   - preferred_username
   ‚Üì
9. VpnClientService.getOrCreateClient():
   - –ò—â–µ—Ç vpn_clients –ø–æ keycloak_user_id
   - –ù–ï –ù–ê–ô–î–ï–ù ‚Üí –°–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å:
     * keycloak_user_id = UUID –∏–∑ JWT
     * email = email –∏–∑ JWT
     * uuid = –Ω–æ–≤—ã–π UUID –¥–ª—è Xray
     * is_active = true
     * created_at = now()
   ‚Üì
10. XrayGrpcClient.addUser(uuid) ‚Üí –î–æ–±–∞–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Xray —á–µ—Ä–µ–∑ gRPC
    ‚Üì
11. ConfigService.generateVlessLink(uuid) ‚Üí –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç VLESS —Å—Å—ã–ª–∫—É
    ‚Üì
12. QrCodeService.generateQrCode(vlessLink) ‚Üí –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç QR –∫–æ–¥
    ‚Üì
13. HomeController –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç index.html —Å QR –∫–æ–¥–æ–º
    ‚Üì
14. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —Å–≤–æ–π QR –∫–æ–¥
```

## üîÑ Flow 2: –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –í—Ö–æ–¥ (SSO)

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí https://ip:8080/
   ‚Üì
2. Spring Security –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–µ—Å—Å–∏—é
   ‚Üì
3. Keycloak –ø—Ä–æ–≤–µ—Ä—è–µ—Ç SSO —Å–µ—Å—Å–∏—é (cookie)
   ‚Üì
4. Keycloak –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç JWT token (–±–µ–∑ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –ª–æ–≥–∏–Ω–∞)
   ‚Üì
5. Spring Security –∏–∑–≤–ª–µ–∫–∞–µ—Ç keycloak_user_id –∏–∑ JWT
   ‚Üì
6. VpnClientService.getOrCreateClient():
   - –ò—â–µ—Ç vpn_clients –ø–æ keycloak_user_id
   - –ù–ê–ô–î–ï–ù ‚Üí –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∑–∞–ø–∏—Å—å
   ‚Üì
7. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –¢–û–¢ –ñ–ï QR –∫–æ–¥ (—Ç–æ—Ç –∂–µ UUID)
   ‚Üì
8. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —Å–≤–æ–π QR –∫–æ–¥
```

```

## üîê SSL/TLS

- **Spring Boot**: HTTPS –Ω–∞ –ø–æ—Ä—Ç—É 8080 —Å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–º `src/main/resources/ssl/keystore.p12`
- **Xray**: Reality –ø—Ä–æ—Ç–æ–∫–æ–ª (TLS fingerprint –º–∞—Å–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–¥ Chrome)
- **Keycloak**: HTTP –≤ dev —Ä–µ–∂–∏–º–µ (–≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –Ω—É–∂–µ–Ω HTTPS)

## ‚è±Ô∏è TTL –õ–æ–≥–∏–∫–∞ (5 –º–∏–Ω—É—Ç)

**Pending Clients (–≤ –ø–∞–º—è—Ç–∏):**
```java
PendingClient {
    uuid: String
    deviceInfo: String
    createdAt: LocalDateTime
    expiresAt: LocalDateTime  // createdAt + 5 –º–∏–Ω—É—Ç
}
```

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –°–æ–∑–¥–∞—ë—Ç—Å—è PendingClient –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR –∫–æ–¥–∞
2. –ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è –∑–∞–¥–∞—á–∞ —á–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç
3. –ß–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç:
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —á–µ—Ä–µ–∑ gRPC
   - –ï—Å–ª–∏ —Ç—Ä–∞—Ñ–∏–∫ > 0 ‚Üí —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î –∫–∞–∫ VpnClient
   - –ï—Å–ª–∏ —Ç—Ä–∞—Ñ–∏–∫ = 0 ‚Üí —É–¥–∞–ª—è–µ—Ç—Å—è –∏–∑ Xray

## üìä –ë–∞–∑–∞ –î–∞–Ω–Ω—ã—Ö

**vpn_clients:**
```sql
id                  BIGSERIAL PRIMARY KEY
keycloak_user_id    UUID UNIQUE NOT NULL
email               VARCHAR(255) UNIQUE NOT NULL
uuid                VARCHAR(36) UNIQUE NOT NULL  -- UUID –¥–ª—è Xray
device_info         VARCHAR(255)
is_active           BOOLEAN DEFAULT true
created_at          TIMESTAMP NOT NULL
first_connected_at  TIMESTAMP
last_connected_at   TIMESTAMP
```

**–ò–Ω–¥–µ–∫—Å—ã:**
- idx_keycloak_user_id
- idx_email
- idx_uuid

## üîó –°–≤—è–∑–∏ –ú–µ–∂–¥—É –°–µ—Ä–≤–∏—Å–∞–º–∏

**Spring Boot ‚Üî Xray:**
- –ü—Ä–æ—Ç–æ–∫–æ–ª: gRPC
- –ü–æ—Ä—Ç: 10085
- –û–ø–µ—Ä–∞—Ü–∏–∏: addUser(), removeUser(), getStats()

**Spring Boot ‚Üî PostgreSQL (vpn_db):**
- –ü—Ä–æ—Ç–æ–∫–æ–ª: JDBC
- –ü–æ—Ä—Ç: 5432
- ORM: Hibernate (JPA)

**Spring Boot ‚Üî Keycloak:**
- –ü—Ä–æ—Ç–æ–∫–æ–ª: OAuth2 / OpenID Connect
- –ü–æ—Ä—Ç—ã: 8180 (–≤–Ω–µ—à–Ω–∏–π), 8080 (–≤–Ω—É—Ç—Ä–∏ Docker)
- Endpoints:
  - authorization: http://localhost:8180/realms/vpn/protocol/openid-connect/auth
  - token: http://keycloak:8080/realms/vpn/protocol/openid-connect/token
  - jwks: http://keycloak:8080/realms/vpn/protocol/openid-connect/certs

**Keycloak ‚Üî PostgreSQL (keycloak_db):**
- –ü—Ä–æ—Ç–æ–∫–æ–ª: JDBC
- –ü–æ—Ä—Ç: 5433
- –ë–∞–∑–∞: keycloak_db

**Xray ‚Üî VPN –ö–ª–∏–µ–Ω—Ç:**
- –ü—Ä–æ—Ç–æ–∫–æ–ª: VLESS + Reality (TLS)
- –ü–æ—Ä—Ç: 443
- –ú–∞—Å–∫–∏—Ä–æ–≤–∫–∞: www.microsoft.com

## üöÄ –ó–∞–ø—É—Å–∫

```bash
```

## üîë Keycloak –ù–∞—Å—Ç—Ä–æ–π–∫–∏

- **Realm**: vpn
- **Client ID**: vpn-client
- **Client Secret**: (–≤ .env)
- **Role**: user
- **Valid Redirect URIs**: https://localhost:8080/*
