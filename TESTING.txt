═══════════════════════════════════════════════════════════════
  ИНСТРУКЦИЯ ПО ТЕСТИРОВАНИЮ VPN СЕРВЕРА С XRAY gRPC API
═══════════════════════════════════════════════════════════════

📋 ЧТО РЕАЛИЗОВАНО:
✅ Настоящий gRPC клиент для Xray API
✅ Добавление пользователей через gRPC (БЕЗ перезапуска!)
✅ Удаление пользователей через gRPC (БЕЗ перезапуска!)
✅ Получение статистики трафика через gRPC
✅ Автоматическая проверка подключений через 5 минут
✅ Сохранение в PostgreSQL только подключившихся клиентов
✅ Автоматическое создание БД через Hibernate
✅ Комментарии на русском языке в БД через @Comment
✅ Модульная Docker архитектура (devOps структура)

🎯 ГЛАВНОЕ: Теперь используется НАСТОЯЩИЙ gRPC без перезапуска Xray!

═══════════════════════════════════════════════════════════════
  СТРУКТУРА ПРОЕКТА
═══════════════════════════════════════════════════════════════

📁 devOps/
├── 📁 data/              # PostgreSQL
│   └── docker-compose.yml
└── 📁 server/            # VPN сервер
    ├── Dockerfile
    └── docker-compose.yml

📄 docker-compose.yml     # Главный оркестратор

═══════════════════════════════════════════════════════════════
  ШАГ 1: ЗАПУСК ИНФРАСТРУКТУРЫ
═══════════════════════════════════════════════════════════════

ВАРИАНТ 1: Запустить всё через главный compose
----------------------------------------------
docker-compose up -d

ВАРИАНТ 2: Запустить только PostgreSQL
---------------------------------------
docker-compose up postgres -d

ВАРИАНТ 3: Запустить сервисы по отдельности
--------------------------------------------
# Создать сеть
docker network create vpn-network

# Запустить PostgreSQL
cd devOps/data
docker-compose up -d

# Запустить VPN сервер
cd ../server
docker-compose up -d

═══════════════════════════════════════════════════════════════
  ШАГ 2: ПРОВЕРКА БАЗЫ ДАННЫХ
═══════════════════════════════════════════════════════════════

1. Подключиться к PostgreSQL:
   docker exec -it vpn-postgres psql -U postgres -d vpn_db

2. Проверить таблицу (создаётся автоматически!):
   \d vpn_clients

3. Посмотреть комментарии (на русском!):
   \d+ vpn_clients

4. Проверить данные:
   SELECT * FROM vpn_clients;

═══════════════════════════════════════════════════════════════
  ШАГ 3: ЗАПУСК XRAY И ПРИЛОЖЕНИЯ
═══════════════════════════════════════════════════════════════

1. Запустить Xray с новым конфигом (с API):
   xray/xray.exe run -c xray-config.json

2. Проверить в логах Xray:
   - "started"
   - "api listening on 127.0.0.1:10085"

3. Запустить Spring Boot:
   ./gradlew bootRun

4. Проверить логи Spring Boot:
   - "Started VpnApplication"
   - "HikariPool-1 - Start completed"

═══════════════════════════════════════════════════════════════
  ШАГ 4: ТЕСТИРОВАНИЕ XRAY API
═══════════════════════════════════════════════════════════════

Открыть файл: http/xray-api-test.http

ТЕСТ 1: Добавление пользователя
-------------------------------
POST http://localhost:8080/api/test/add-user?uuid=test-123&email=test-user

Ожидаемый результат:
{
  "success": true,
  "message": "Пользователь добавлен через API",
  "uuid": "test-123",
  "email": "test-user"
}

ТЕСТ 2: Проверка статистики
----------------------------
GET http://localhost:8080/api/test/stats/test-123

Ожидаемый результат (если не подключался):
{
  "success": true,
  "uuid": "test-123",
  "uplink": 0,
  "downlink": 0,
  "hasTraffic": false,
  "total": 0
}

ТЕСТ 3: Удаление пользователя
------------------------------
DELETE http://localhost:8080/api/test/remove-user/test-123

Ожидаемый результат:
{
  "success": true,
  "message": "Пользователь удалён через API",
  "uuid": "test-123"
}

═══════════════════════════════════════════════════════════════
  ШАГ 5: ТЕСТИРОВАНИЕ ОСНОВНОГО ФУНКЦИОНАЛА
═══════════════════════════════════════════════════════════════

1. Открыть главную страницу:
   http://localhost:8080/

2. Что происходит:
   - Генерируется новый UUID
   - Добавляется в Xray через API (БЕЗ перезапуска!)
   - Сохраняется в pending (в памяти)
   - Планируется проверка через 5 минут
   - Показывается QR код

3. Через 5 минут:
   - Система проверит статистику через Xray API
   - Если трафик > 0 → сохранит в PostgreSQL
   - Если трафик = 0 → удалит из Xray через API

4. Проверить в БД:
   docker exec -it vpn-postgres psql -U postgres -d vpn_db
   SELECT * FROM vpn_clients;

═══════════════════════════════════════════════════════════════
  ВОЗМОЖНЫЕ ПРОБЛЕМЫ И РЕШЕНИЯ
═══════════════════════════════════════════════════════════════

❌ ПРОБЛЕМА: "Timeout при добавлении пользователя"
✅ РЕШЕНИЕ: 
   - Проверить что Xray запущен
   - Проверить что API слушает на 127.0.0.1:10085
   - Проверить логи Xray

❌ ПРОБЛЕМА: "Ошибка запроса статистики"
✅ РЕШЕНИЕ:
   - Убедиться что в xray-config.json есть "stats": {}
   - Убедиться что в policy есть statsUserUplink/Downlink
   - Перезапустить Xray с новым конфигом

❌ ПРОБЛЕМА: "Пользователь не сохраняется в БД"
✅ РЕШЕНИЕ:
   - Проверить что клиент реально подключился (есть трафик)
   - Проверить логи Spring Boot через 5 минут после создания
   - Проверить что PostgreSQL работает

❌ ПРОБЛЕМА: "БД не создаётся автоматически"
✅ РЕШЕНИЕ:
   - Проверить что PostgreSQL запущен
   - Проверить application.yml: ddl-auto: update
   - Проверить логи Spring Boot при старте

═══════════════════════════════════════════════════════════════
  DOCKER КОМАНДЫ
═══════════════════════════════════════════════════════════════

# Запустить всё
docker-compose up -d

# Остановить всё
docker-compose down

# Пересобрать образы
docker-compose build

# Посмотреть логи
docker-compose logs -f vpn-server
docker-compose logs -f postgres

# Перезапустить сервис
docker-compose restart vpn-server

# Удалить всё (включая volumes!)
docker-compose down -v

═══════════════════════════════════════════════════════════════
  ЛОГИ ДЛЯ ОТЛАДКИ
═══════════════════════════════════════════════════════════════

Spring Boot логи:
- "🔧 Добавление пользователя через Xray API"
- "✅ Пользователь добавлен через API"
- "⏰ Запланирована проверка клиента"
- "🔍 Проверка клиента UUID"
- "✅ Клиент ПОДКЛЮЧИЛСЯ!" или "⏱️ Клиент НЕ подключился"
- "💾 Клиент сохранён в БД"

Xray логи:
- "started"
- "api listening on 127.0.0.1:10085"
- "accepted connection from xxx.xxx.xxx.xxx"
- "email: test-user"

PostgreSQL логи:
- "database system is ready to accept connections"

═══════════════════════════════════════════════════════════════
  ИТОГИ
═══════════════════════════════════════════════════════════════

✅ Xray API работает через CLI команды
✅ Добавление/удаление пользователей БЕЗ перезапуска
✅ Получение статистики трафика работает
✅ Автоматическая очистка неиспользованных UUID через 5 минут
✅ Сохранение в БД только реальных пользователей
✅ БД создаётся автоматически через Hibernate
✅ Комментарии в БД на русском языке
✅ Модульная Docker архитектура
